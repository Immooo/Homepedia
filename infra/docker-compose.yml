x-env: &default-env
  STREAMLIT_SERVER_PORT: ${STREAMLIT_SERVER_PORT:-8501}
  DB_PATH: ${DB_PATH:-/app/data/homepedia.db}
  PYTHONUNBUFFERED: "1"
  PYTHONPATH: "/app"

services:
  app:
    build:
      context: ..
      dockerfile: Dockerfile
    image: homepedia-app:latest
    container_name: homepedia-app
    env_file:
      - ../.env
    environment:
      <<: *default-env
      STREAMLIT_SERVER_HEADLESS: "true"
      MONGO_URI: ${MONGO_URI:-mongodb://mongo:27017}
      MONGO_DB: ${MONGO_DB:-homepedia}
    volumes:
      - ../data:/app/data:rw
      - ../src:/app/src:rw
      - ../outputs:/app/outputs:rw
    working_dir: /app
    ports:
      - "${STREAMLIT_SERVER_PORT:-8501}:8501"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8501/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  realtime-price:
    build:
      context: ..
      dockerfile: Dockerfile
    image: homepedia-app:latest
    container_name: homepedia-realtime-price
    env_file:
      - ../.env
    environment:
      <<: *default-env
      MONGO_URI: ${MONGO_URI:-mongodb://mongo:27017}
      MONGO_DB: ${MONGO_DB:-homepedia}
      POLL_INTERVAL_SECONDS: ${POLL_INTERVAL_SECONDS:-300}
      INSEE_SOURCE_URL: ${INSEE_SOURCE_URL:-https://www.insee.fr/fr/statistiques/8669035}
      REALTIME_REQUEST_TIMEOUT_SECONDS: ${REALTIME_REQUEST_TIMEOUT_SECONDS:-20}
    volumes:
      - ../data:/app/data:rw
      - ../src:/app/src:rw
      - ../outputs:/app/outputs:rw
    working_dir: /app
    depends_on:
      - mongo
    command: ["python", "-m", "src.realtime_price.worker"]
    restart: unless-stopped

  metabase:
    image: metabase/metabase:latest
    container_name: homepedia-metabase
    ports:
      - "3000:3000"
    environment:
      MB_DB_FILE: /metabase-data/metabase.db
    volumes:
      - metabase-data:/metabase-data
      - ../data:/data:ro
    depends_on:
      - app
    restart: unless-stopped

  mongo:
    image: mongo:7
    container_name: homepedia-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - ../mongo_data:/data/db

volumes:
  metabase-data:
